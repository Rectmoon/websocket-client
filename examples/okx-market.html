<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OKX å…¬å…±è¡Œæƒ… WebSocket Demo</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
          Oxygen, Ubuntu, sans-serif;
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 28px;
        margin-bottom: 10px;
      }

      .header .subtitle {
        font-size: 14px;
        opacity: 0.9;
      }

      .status {
        display: inline-block;
        padding: 6px 16px;
        border-radius: 20px;
        font-size: 14px;
        margin-top: 10px;
        background: rgba(255, 255, 255, 0.2);
      }

      .status.connected {
        background: rgba(76, 175, 80, 0.9);
      }

      .status.disconnected {
        background: rgba(244, 67, 54, 0.9);
      }

      .control-panel {
        padding: 20px;
        background: #f5f5f5;
        border-bottom: 1px solid #e0e0e0;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group:last-child {
        margin-bottom: 0;
      }

      label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: #333;
        font-size: 14px;
      }

      input[type='text'],
      select {
        width: 100%;
        padding: 10px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.3s;
      }

      input[type='text']:focus,
      select:focus {
        outline: none;
        border-color: #2a5298;
      }

      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
      }

      .btn-primary {
        background: #2a5298;
        color: white;
      }

      .btn-primary:hover:not(:disabled) {
        background: #1e3c72;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(42, 82, 152, 0.4);
      }

      .btn-danger {
        background: #f44336;
        color: white;
      }

      .btn-danger:hover:not(:disabled) {
        background: #d32f2f;
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .btn-group {
        display: flex;
        gap: 10px;
      }

      .data-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        padding: 20px;
      }

      @media (max-width: 768px) {
        .data-container {
          grid-template-columns: 1fr;
        }
      }

      .data-panel {
        background: #fafafa;
        border-radius: 12px;
        padding: 20px;
        min-height: 400px;
      }

      .data-panel h3 {
        margin-bottom: 15px;
        color: #333;
        font-size: 18px;
      }

      .ticker-item {
        background: white;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .ticker-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .ticker-symbol {
        font-weight: 600;
        font-size: 16px;
        color: #2a5298;
      }

      .ticker-price {
        font-size: 20px;
        font-weight: 700;
        color: #333;
      }

      .ticker-price.up {
        color: #4caf50;
      }

      .ticker-price.down {
        color: #f44336;
      }

      .ticker-info {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        font-size: 13px;
        color: #666;
      }

      .ticker-info-item {
        display: flex;
        justify-content: space-between;
      }

      .ticker-info-label {
        color: #999;
      }

      .log-container {
        background: #1e1e1e;
        color: #d4d4d4;
        padding: 15px;
        border-radius: 8px;
        max-height: 400px;
        overflow-y: auto;
        font-family: 'Courier New', monospace;
        font-size: 12px;
      }

      .log-item {
        margin-bottom: 8px;
        padding: 4px 0;
        border-bottom: 1px solid #333;
      }

      .log-item:last-child {
        border-bottom: none;
      }

      .log-time {
        color: #858585;
        margin-right: 8px;
      }

      .log-type {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 10px;
        margin-right: 8px;
        font-weight: 600;
      }

      .log-type.send {
        background: #4caf50;
        color: white;
      }

      .log-type.receive {
        background: #2196f3;
        color: white;
      }

      .log-type.error {
        background: #f44336;
        color: white;
      }

      .log-type.info {
        background: #ff9800;
        color: white;
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #999;
      }

      .empty-state-icon {
        font-size: 48px;
        margin-bottom: 10px;
      }

      /* æ»šåŠ¨æ¡æ ·å¼ */
      .log-container::-webkit-scrollbar {
        width: 6px;
      }

      .log-container::-webkit-scrollbar-track {
        background: #2a2a2a;
      }

      .log-container::-webkit-scrollbar-thumb {
        background: #555;
        border-radius: 3px;
      }

      .log-container::-webkit-scrollbar-thumb:hover {
        background: #777;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ğŸ“ˆ OKX å…¬å…±è¡Œæƒ… WebSocket</h1>
        <div class="subtitle">å®æ—¶è¡Œæƒ…æ•°æ®ç›‘æ§</div>
        <div class="status" id="status">æœªè¿æ¥</div>
      </div>

      <div class="control-panel">
        <div class="form-group">
          <label for="symbol">äº¤æ˜“å¯¹:</label>
          <select id="symbol">
            <option value="BTC-USDT">BTC-USDT</option>
            <option value="ETH-USDT">ETH-USDT</option>
            <option value="BNB-USDT">BNB-USDT</option>
            <option value="SOL-USDT">SOL-USDT</option>
            <option value="DOGE-USDT">DOGE-USDT</option>
          </select>
        </div>
        <div class="form-group">
          <div class="btn-group">
            <button class="btn btn-primary" id="connectBtn" onclick="connect()">
              è¿æ¥
            </button>
            <button
              class="btn btn-danger"
              id="disconnectBtn"
              onclick="disconnect()"
              disabled
            >
              æ–­å¼€
            </button>
            <button
              class="btn btn-primary"
              id="subscribeBtn"
              onclick="subscribe()"
              disabled
            >
              è®¢é˜…è¡Œæƒ…
            </button>
          </div>
        </div>
      </div>

      <div class="data-container">
        <div class="data-panel">
          <h3>ğŸ“Š è¡Œæƒ…æ•°æ®</h3>
          <div id="tickerContainer">
            <div class="empty-state">
              <div class="empty-state-icon">ğŸ“ˆ</div>
              <div>è¿æ¥å¹¶è®¢é˜…åæ˜¾ç¤ºè¡Œæƒ…æ•°æ®</div>
            </div>
          </div>
        </div>

        <div class="data-panel">
          <h3>ğŸ“ æ¶ˆæ¯æ—¥å¿—</h3>
          <div class="log-container" id="logContainer"></div>
        </div>
      </div>
    </div>

    <!-- å¼•å…¥æ‰“åŒ…åçš„ UMD æ–‡ä»¶ -->
    <script src="../../dist/core/index.umd.js"></script>

    <script>
      // è·å– DOM å…ƒç´ 
      const statusEl = document.getElementById('status')
      const connectBtn = document.getElementById('connectBtn')
      const disconnectBtn = document.getElementById('disconnectBtn')
      const subscribeBtn = document.getElementById('subscribeBtn')
      const symbolSelect = document.getElementById('symbol')
      const tickerContainer = document.getElementById('tickerContainer')
      const logContainer = document.getElementById('logContainer')

      // ä½¿ç”¨ UMD å…¨å±€å˜é‡
      const { WebSocketClient } = WebSocketCore

      let client = null
      let tickerData = {}

      // è¿æ¥
      function connect() {
        if (client) {
          disconnect()
        }

        try {
          // åˆ›å»ºå®¢æˆ·ç«¯
          client = new WebSocketClient({
            url: 'wss://ws.okx.com:8443/ws/v5/public',
            heartbeatInterval: false, // OKX æœ‰è‡ªå·±çš„å¿ƒè·³æœºåˆ¶
            pongTimeout: false,
            reconnectDelay: 1000,
            maxReconnectDelay: 30000,
            strictJsonMode: false,
            messageParser: data => {
              // OKX è¿”å› JSON æ ¼å¼çš„æ¶ˆæ¯
              if (typeof data === 'string') {
                try {
                  const parsed = JSON.parse(data)

                  // OKX æ¶ˆæ¯æ ¼å¼å¯èƒ½æ˜¯æ•°ç»„æˆ–å¯¹è±¡
                  if (Array.isArray(parsed)) {
                    // å¦‚æœæ˜¯æ•°ç»„ï¼Œå¤„ç†æ¯ä¸ªå…ƒç´ 
                    return {
                      channel: 'okx_data',
                      data: parsed
                    }
                  }

                  // å¦‚æœæ˜¯å¯¹è±¡ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯æ§åˆ¶æ¶ˆæ¯
                  if (
                    parsed.op &&
                    (parsed.op === 'subscribe' || parsed.op === 'unsubscribe')
                  ) {
                    // è¿‡æ»¤æ‰è®¢é˜…/å–æ¶ˆè®¢é˜…çš„æ§åˆ¶æ¶ˆæ¯
                    return {
                      channel: '__ignore__',
                      data: parsed
                    }
                  }

                  // æ ‡å‡†æ¶ˆæ¯æ ¼å¼
                  if (parsed.channel) {
                    return {
                      channel: parsed.channel,
                      data: parsed
                    }
                  }

                  // å…¶ä»–æ¶ˆæ¯åŒ…è£…ä¸º okx_data
                  return {
                    channel: 'okx_data',
                    data: parsed
                  }
                } catch {
                  return {
                    channel: 'message',
                    data: data
                  }
                }
              }

              return {
                channel: 'binary',
                data: data
              }
            }
          })

          // ç›‘å¬è¿æ¥çŠ¶æ€
          client.onConnectionStateChange(connected => {
            updateConnectionStatus(connected)
          })

          // ç›´æ¥ç›‘å¬æ‰€æœ‰æ¶ˆæ¯ï¼ˆä¸ä½¿ç”¨ subscribeï¼Œé¿å…å‘é€é”™è¯¯çš„è®¢é˜…æ ¼å¼ï¼‰
          // OKX ä½¿ç”¨è‡ªå·±çš„è®¢é˜…æ ¼å¼ {"op": "subscribe", "args": [...]}
          // æˆ‘ä»¬éœ€è¦ç»•è¿‡ SubscriptionManager çš„è‡ªåŠ¨è®¢é˜…åŠŸèƒ½
          const wsManager = client['wsManager']
          const messageRouter = client['messageRouter']

          if (wsManager && messageRouter) {
            // ç›´æ¥é€šè¿‡ MessageRouter æ³¨å†Œå›è°ƒï¼Œä¸è§¦å‘è‡ªåŠ¨è®¢é˜…
            // è¿™æ ·ä¸ä¼šå‘é€ {"action":"subscribe","channel":"..."} æ¶ˆæ¯
            messageRouter.register('okx_data', data => {
              handleOKXData(data)
            })

            messageRouter.register('tickers', data => {
              handleTickerData(data)
            })

            messageRouter.register('message', data => {
              // å¤„ç†å…¶ä»–æ¶ˆæ¯ï¼ˆå¯èƒ½æ˜¯é”™è¯¯æ¶ˆæ¯ç­‰ï¼‰
              handleOKXData(data)
            })
          }

          // è¿æ¥
          client.connect()
          addLog('æ­£åœ¨è¿æ¥åˆ° OKX WebSocket...', 'info')
        } catch (error) {
          console.error('è¿æ¥å¤±è´¥:', error)
          addLog('è¿æ¥å¤±è´¥: ' + error.message, 'error')
          alert('è¿æ¥å¤±è´¥: ' + error.message)
        }
      }

      // æ–­å¼€è¿æ¥
      function disconnect() {
        if (client) {
          client.disconnect()
          client = null
          tickerData = {}
          renderTickers()
          addLog('å·²æ–­å¼€è¿æ¥', 'info')
        }
      }

      // è®¢é˜…è¡Œæƒ…
      function subscribe() {
        if (!client || !client.isConnected()) {
          alert('è¯·å…ˆè¿æ¥åˆ°æœåŠ¡å™¨')
          return
        }

        const symbol = symbolSelect.value
        const subscribeMsg = {
          op: 'subscribe',
          args: [
            {
              channel: 'tickers',
              instId: symbol
            }
          ]
        }

        try {
          client.send(subscribeMsg)
          addLog(`è®¢é˜… ${symbol} è¡Œæƒ…`, 'send', subscribeMsg)
        } catch (error) {
          console.error('è®¢é˜…å¤±è´¥:', error)
          addLog('è®¢é˜…å¤±è´¥: ' + error.message, 'error')
        }
      }

      // å¤„ç† OKX æ•°æ®
      function handleOKXData(data) {
        // OKX å¯èƒ½è¿”å›æ•°ç»„æ ¼å¼çš„æ•°æ®
        if (Array.isArray(data)) {
          data.forEach(item => {
            if (item.arg && item.arg.channel === 'tickers') {
              handleTickerData(item)
            }
          })
        } else if (data.arg && data.arg.channel === 'tickers') {
          handleTickerData(data)
        }
      }

      // å¤„ç†è¡Œæƒ…æ•°æ®
      function handleTickerData(data) {
        if (data.data && Array.isArray(data.data) && data.data.length > 0) {
          const ticker = data.data[0]
          const instId = ticker.instId || data.arg?.instId

          if (instId) {
            tickerData[instId] = {
              ...ticker,
              timestamp: Date.now()
            }
            renderTickers()
            addLog(`æ”¶åˆ° ${instId} è¡Œæƒ…æ•°æ®`, 'receive', ticker)
          }
        }
      }

      // æ¸²æŸ“è¡Œæƒ…æ•°æ®
      function renderTickers() {
        const tickers = Object.values(tickerData)

        if (tickers.length === 0) {
          tickerContainer.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">ğŸ“ˆ</div>
              <div>æš‚æ— è¡Œæƒ…æ•°æ®</div>
            </div>
          `
          return
        }

        tickerContainer.innerHTML = tickers
          .map(ticker => {
            const instId = ticker.instId || 'N/A'
            const last = parseFloat(ticker.last || ticker.lastPx || 0)
            const open24h = parseFloat(ticker.open24h || ticker.sodUtc8 || 0)
            const change24h =
              open24h > 0
                ? (((last - open24h) / open24h) * 100).toFixed(2)
                : '0.00'
            const changeClass = parseFloat(change24h) >= 0 ? 'up' : 'down'
            const vol24h = parseFloat(
              ticker.vol24h || ticker.volCcy24h || 0
            ).toLocaleString()
            const high24h = parseFloat(
              ticker.high24h || ticker.high24h || 0
            ).toLocaleString()
            const low24h = parseFloat(
              ticker.low24h || ticker.low24h || 0
            ).toLocaleString()

            return `
              <div class="ticker-item">
                <div class="ticker-header">
                  <span class="ticker-symbol">${instId}</span>
                  <span class="ticker-price ${changeClass}">${last.toLocaleString()}</span>
                </div>
                <div class="ticker-info">
                  <div class="ticker-info-item">
                    <span class="ticker-info-label">24h æ¶¨è·Œ:</span>
                    <span class="${changeClass}">${change24h}%</span>
                  </div>
                  <div class="ticker-info-item">
                    <span class="ticker-info-label">24h æˆäº¤é‡:</span>
                    <span>${vol24h}</span>
                  </div>
                  <div class="ticker-info-item">
                    <span class="ticker-info-label">24h æœ€é«˜:</span>
                    <span>${high24h}</span>
                  </div>
                  <div class="ticker-info-item">
                    <span class="ticker-info-label">24h æœ€ä½:</span>
                    <span>${low24h}</span>
                  </div>
                </div>
              </div>
            `
          })
          .join('')
      }

      // æ›´æ–°è¿æ¥çŠ¶æ€
      function updateConnectionStatus(connected) {
        if (connected) {
          statusEl.textContent = 'å·²è¿æ¥'
          statusEl.className = 'status connected'
          connectBtn.disabled = true
          disconnectBtn.disabled = false
          subscribeBtn.disabled = false
          addLog('è¿æ¥æˆåŠŸï¼', 'info')
        } else {
          statusEl.textContent = 'æœªè¿æ¥'
          statusEl.className = 'status disconnected'
          connectBtn.disabled = false
          disconnectBtn.disabled = true
          subscribeBtn.disabled = true
        }
      }

      // æ·»åŠ æ—¥å¿—
      function addLog(message, type = 'info', data = null) {
        const time = new Date().toLocaleTimeString()
        const logItem = document.createElement('div')
        logItem.className = 'log-item'

        let logContent = `<span class="log-time">${time}</span>`
        logContent += `<span class="log-type ${type}">${type.toUpperCase()}</span>`
        logContent += `<span>${message}</span>`

        if (data) {
          logContent += `<pre style="margin-top: 4px; font-size: 11px; color: #858585;">${JSON.stringify(
            data,
            null,
            2
          )}</pre>`
        }

        logItem.innerHTML = logContent
        logContainer.appendChild(logItem)
        logContainer.scrollTop = logContainer.scrollHeight
      }

      // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
      window.addEventListener('load', () => {
        console.log('OKX Market Demo loaded')
        console.log('Available:', typeof WebSocketCore !== 'undefined')
      })

      // é¡µé¢å…³é—­å‰æ–­å¼€è¿æ¥
      window.addEventListener('beforeunload', () => {
        if (client) {
          client.disconnect()
        }
      })
    </script>
  </body>
</html>
