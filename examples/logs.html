<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebSocket Echo æµ‹è¯•</title>
    <style>
      body {
        font-family: monospace;
        padding: 20px;
        background: #1e1e1e;
        color: #d4d4d4;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
      }
      h1 {
        color: #4ec9b0;
      }
      .log {
        background: #252526;
        border: 1px solid #3e3e42;
        border-radius: 4px;
        padding: 15px;
        margin: 10px 0;
        max-height: 400px;
        overflow-y: auto;
      }
      .log-entry {
        padding: 5px;
        margin: 5px 0;
        border-left: 3px solid #007acc;
        padding-left: 10px;
      }
      .log-entry.success {
        border-left-color: #4ec9b0;
      }
      .log-entry.error {
        border-left-color: #f48771;
        color: #f48771;
      }
      .log-entry.info {
        border-left-color: #dcdcaa;
        color: #dcdcaa;
      }
      button {
        background: #0e639c;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
        font-size: 14px;
      }
      button:hover {
        background: #1177bb;
      }
      button:disabled {
        background: #3e3e42;
        cursor: not-allowed;
      }
      .status {
        display: inline-block;
        padding: 5px 15px;
        border-radius: 4px;
        margin: 10px 0;
        font-weight: bold;
      }
      .status.connected {
        background: #4ec9b0;
        color: #1e1e1e;
      }
      .status.disconnected {
        background: #f48771;
        color: #1e1e1e;
      }
      input {
        padding: 10px;
        border: 1px solid #3e3e42;
        border-radius: 4px;
        background: #252526;
        color: #d4d4d4;
        font-size: 14px;
        width: 300px;
      }
      .controls {
        margin: 20px 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ§ª WebSocket Echo æµ‹è¯•</h1>

      <div class="status" id="status">æœªè¿æ¥</div>

      <div class="controls">
        <button id="connectBtn" onclick="testConnect()">è¿æ¥</button>
        <button id="disconnectBtn" onclick="testDisconnect()" disabled>
          æ–­å¼€
        </button>
        <button onclick="testSendText()">å‘é€æ–‡æœ¬</button>
        <button onclick="testSendJSON()">å‘é€ JSON</button>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
      </div>

      <div class="controls">
        <input type="text" id="customMessage" placeholder="è¾“å…¥è‡ªå®šä¹‰æ¶ˆæ¯..." />
        <button onclick="sendCustomMessage()">å‘é€</button>
      </div>

      <h2>ğŸ“‹ æµ‹è¯•æ—¥å¿—</h2>
      <div class="log" id="log"></div>
    </div>

    <!-- å¼•å…¥ WebSocket åº“ -->
    <script src="../../dist/core/index.umd.js"></script>

    <script>
      const { WebSocketClient } = WebSocketCore
      let client = null
      let messageCount = 0

      // æ—¥å¿—å·¥å…·
      function addLog(message, type = 'info') {
        const logDiv = document.getElementById('log')
        const entry = document.createElement('div')
        entry.className = `log-entry ${type}`
        const timestamp = new Date().toLocaleTimeString()
        entry.textContent = `[${timestamp}] ${message}`
        logDiv.appendChild(entry)
        logDiv.scrollTop = logDiv.scrollHeight
      }

      function clearLog() {
        document.getElementById('log').innerHTML = ''
        messageCount = 0
        addLog('æ—¥å¿—å·²æ¸…ç©º', 'info')
      }

      // æ›´æ–°çŠ¶æ€
      function updateStatus(connected) {
        const statusEl = document.getElementById('status')
        const connectBtn = document.getElementById('connectBtn')
        const disconnectBtn = document.getElementById('disconnectBtn')

        if (connected) {
          statusEl.textContent = 'å·²è¿æ¥'
          statusEl.className = 'status connected'
          connectBtn.disabled = true
          disconnectBtn.disabled = false
        } else {
          statusEl.textContent = 'æœªè¿æ¥'
          statusEl.className = 'status disconnected'
          connectBtn.disabled = false
          disconnectBtn.disabled = true
        }
      }

      // æµ‹è¯•è¿æ¥
      function testConnect() {
        addLog('å¼€å§‹æµ‹è¯•...', 'info')
        addLog('åˆ›å»º WebSocket å®¢æˆ·ç«¯', 'info')

        try {
          client = new WebSocketClient({
            url: 'wss://echo.websocket.org',
            heartbeatInterval: 30000
          })

          addLog('âœ“ å®¢æˆ·ç«¯åˆ›å»ºæˆåŠŸ', 'success')

          // ç›‘å¬è¿æ¥çŠ¶æ€
          client.onConnectionStateChange(connected => {
            if (connected) {
              addLog('âœ“ WebSocket è¿æ¥å·²å»ºç«‹', 'success')
            } else {
              addLog('âœ— WebSocket è¿æ¥å·²æ–­å¼€', 'error')
            }
            updateStatus(connected)
          })

          // è®¢é˜…æ¶ˆæ¯
          client.subscribe('message', data => {
            console.log({ data })
            messageCount++
            addLog(`âœ“ æ”¶åˆ°æ¶ˆæ¯ #${messageCount}`, 'success')

            // æ˜¾ç¤ºæ•°æ®ç±»å‹
            const dataType = typeof data
            addLog(`  ç±»å‹: ${dataType}`, 'info')

            // æ˜¾ç¤ºå†…å®¹
            const content =
              typeof data === 'string' ? data : JSON.stringify(data, null, 2)
            addLog(`  å†…å®¹: ${content}`, 'info')
          })

          addLog('âœ“ æ¶ˆæ¯è®¢é˜…å·²è®¾ç½®', 'success')

          // å¼€å§‹è¿æ¥
          client.connect()
          addLog('æ­£åœ¨è¿æ¥åˆ° wss://echo.websocket.org ...', 'info')
        } catch (error) {
          addLog(`âœ— é”™è¯¯: ${error.message}`, 'error')
          console.error(error)
        }
      }

      // æµ‹è¯•æ–­å¼€
      function testDisconnect() {
        if (client) {
          client.disconnect()
          addLog('ä¸»åŠ¨æ–­å¼€è¿æ¥', 'info')
        }
      }

      // æµ‹è¯•å‘é€æ–‡æœ¬
      function testSendText() {
        if (!client || !client.isConnected()) {
          addLog('âœ— è¯·å…ˆè¿æ¥åˆ°æœåŠ¡å™¨', 'error')
          return
        }

        const testMessage = 'Hello from WebSocket Client!'
        addLog(`â†’ å‘é€æ–‡æœ¬æ¶ˆæ¯: "${testMessage}"`, 'info')

        // æ³¨æ„ï¼šæˆ‘ä»¬çš„åº“ä¸»è¦ç”¨äºæ¥æ”¶æ¶ˆæ¯
        // è¿™é‡Œåªæ˜¯æ·»åŠ åˆ°æ—¥å¿—ï¼Œå®é™… echo æœåŠ¡å™¨ä¼šå›æ˜¾æˆ‘ä»¬é€šè¿‡å…¶ä»–æ–¹å¼å‘é€çš„æ¶ˆæ¯
        addLog('  æç¤º: å½“å‰åº“ç‰ˆæœ¬ä¸»è¦ç”¨äºæ¥æ”¶æ¶ˆæ¯', 'info')
        addLog('  Echo æœåŠ¡å™¨ä¼šå›æ˜¾ä»»ä½•å®ƒæ”¶åˆ°çš„æ¶ˆæ¯', 'info')
      }

      // æµ‹è¯•å‘é€ JSON
      function testSendJSON() {
        if (!client || !client.isConnected()) {
          addLog('âœ— è¯·å…ˆè¿æ¥åˆ°æœåŠ¡å™¨', 'error')
          return
        }

        const jsonMessage = {
          type: 'test',
          message: 'Hello from JSON!',
          timestamp: Date.now()
        }

        addLog(`â†’ å°è¯•å‘é€ JSON: ${JSON.stringify(jsonMessage)}`, 'info')
        addLog('  æç¤º: å½“å‰åº“ç‰ˆæœ¬ä¸»è¦ç”¨äºæ¥æ”¶æ¶ˆæ¯', 'info')
      }

      // å‘é€è‡ªå®šä¹‰æ¶ˆæ¯
      function sendCustomMessage() {
        const input = document.getElementById('customMessage')
        const message = input.value.trim()

        if (!message) {
          addLog('âœ— è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹', 'error')
          return
        }

        if (!client || !client.isConnected()) {
          addLog('âœ— è¯·å…ˆè¿æ¥åˆ°æœåŠ¡å™¨', 'error')
          return
        }

        addLog(`â†’ è‡ªå®šä¹‰æ¶ˆæ¯: "${message}"`, 'info')
        input.value = ''
      }

      // é¡µé¢åŠ è½½æ—¶çš„æç¤º
      window.addEventListener('load', () => {
        addLog('=== WebSocket Echo æµ‹è¯•å·¥å…· ===', 'info')
        addLog('', 'info')
        addLog('æµ‹è¯•æ­¥éª¤:', 'info')
        addLog('1. ç‚¹å‡»"è¿æ¥"æŒ‰é’®', 'info')
        addLog('2. è§‚å¯Ÿè¿æ¥çŠ¶æ€å’Œæ—¥å¿—è¾“å‡º', 'info')
        addLog('3. Echo æœåŠ¡å™¨ä¼šå›æ˜¾æ‰€æœ‰æ”¶åˆ°çš„æ¶ˆæ¯', 'info')
        addLog('', 'info')
        addLog('é¢„æœŸç»“æœ:', 'info')
        addLog('âœ“ è¿æ¥æˆåŠŸï¼ˆæ—  JSON è§£æé”™è¯¯ï¼‰', 'success')
        addLog('âœ“ èƒ½å¤Ÿæ¥æ”¶çº¯æ–‡æœ¬æ¶ˆæ¯', 'success')
        addLog('âœ“ æ¶ˆæ¯ç±»å‹æ­£ç¡®è¯†åˆ«', 'success')
        addLog('', 'info')
      })

      // é¡µé¢å…³é—­å‰æ–­å¼€è¿æ¥
      window.addEventListener('beforeunload', () => {
        if (client) {
          client.disconnect()
        }
      })

      // å¿«é€Ÿæµ‹è¯•å‡½æ•°ï¼ˆåœ¨æ§åˆ¶å°è°ƒç”¨ï¼‰
      window.runQuickTest = function () {
        addLog('=== å¼€å§‹å¿«é€Ÿæµ‹è¯• ===', 'info')

        testConnect()

        setTimeout(() => {
          addLog('å¿«é€Ÿæµ‹è¯•å®Œæˆï¼', 'success')
          addLog('å¦‚æœæ²¡æœ‰ JSON è§£æé”™è¯¯ï¼Œè¯´æ˜ä¿®å¤æˆåŠŸï¼', 'success')
        }, 3000)
      }

      // æç¤ºç”¨æˆ·å¯ä»¥åœ¨æ§åˆ¶å°è¿è¡Œå¿«é€Ÿæµ‹è¯•
      console.log(
        '%cè¿è¡Œå¿«é€Ÿæµ‹è¯•',
        'color: #4ec9b0; font-size: 16px; font-weight: bold;'
      )
      console.log('%cwindow.runQuickTest()', 'color: #dcdcaa; font-size: 14px;')
    </script>
  </body>
</html>
