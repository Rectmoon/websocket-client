<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebSocket Chat Demo - HTML</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
          Oxygen, Ubuntu, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .container {
        width: 100%;
        max-width: 600px;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        text-align: center;
      }

      .header h1 {
        font-size: 24px;
        margin-bottom: 10px;
      }

      .status {
        display: inline-block;
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 14px;
        background: rgba(255, 255, 255, 0.2);
      }

      .status.connected {
        background: rgba(76, 175, 80, 0.8);
      }

      .status.disconnected {
        background: rgba(244, 67, 54, 0.8);
      }

      .connection-form {
        padding: 20px;
        background: #f5f5f5;
        border-bottom: 1px solid #e0e0e0;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group:last-child {
        margin-bottom: 0;
      }

      label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: #333;
      }

      input[type='text'] {
        width: 100%;
        padding: 10px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.3s;
      }

      input[type='text']:focus {
        outline: none;
        border-color: #667eea;
      }

      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
      }

      .btn-primary {
        background: #667eea;
        color: white;
      }

      .btn-primary:hover:not(:disabled) {
        background: #5568d3;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      }

      .btn-danger {
        background: #f44336;
        color: white;
      }

      .btn-danger:hover:not(:disabled) {
        background: #d32f2f;
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .chat-container {
        height: 400px;
        overflow-y: auto;
        padding: 20px;
        background: #fafafa;
      }

      .message {
        margin-bottom: 15px;
        animation: slideIn 0.3s ease;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .message-header {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
      }

      .message-user {
        font-weight: 600;
        color: #667eea;
        margin-right: 10px;
      }

      .message-time {
        font-size: 12px;
        color: #999;
      }

      .message-content {
        background: white;
        padding: 12px;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        word-wrap: break-word;
      }

      .message.own .message-content {
        background: #667eea;
        color: white;
      }

      .message.own .message-user {
        color: #764ba2;
      }

      .message.system {
        text-align: center;
      }

      .message.system .message-content {
        background: #e3f2fd;
        color: #1976d2;
        display: inline-block;
        font-size: 13px;
      }

      .input-container {
        padding: 20px;
        background: white;
        border-top: 1px solid #e0e0e0;
      }

      .input-group {
        display: flex;
        gap: 10px;
      }

      .input-group input {
        flex: 1;
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #999;
      }

      .empty-state-icon {
        font-size: 48px;
        margin-bottom: 10px;
      }

      /* æ»šåŠ¨æ¡æ ·å¼ */
      .chat-container::-webkit-scrollbar {
        width: 6px;
      }

      .chat-container::-webkit-scrollbar-track {
        background: #f1f1f1;
      }

      .chat-container::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 3px;
      }

      .chat-container::-webkit-scrollbar-thumb:hover {
        background: #555;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ğŸ’¬ WebSocket èŠå¤©å®¤</h1>
        <div class="status" id="status">æœªè¿æ¥</div>
      </div>

      <div class="connection-form" id="connectionForm">
        <div class="form-group">
          <label for="wsUrl">WebSocket URL:</label>
          <input
            type="text"
            id="wsUrl"
            value="wss://echo.websocket.org"
            placeholder="wss://your-websocket-server.com"
          />
        </div>
        <div class="form-group">
          <label for="username">ç”¨æˆ·å:</label>
          <input
            type="text"
            id="username"
            value="User"
            placeholder="è¯·è¾“å…¥ç”¨æˆ·å"
          />
        </div>
        <div class="form-group">
          <button class="btn btn-primary" id="connectBtn" onclick="connect()">
            è¿æ¥
          </button>
          <button
            class="btn btn-danger"
            id="disconnectBtn"
            onclick="disconnect()"
            disabled
          >
            æ–­å¼€
          </button>
        </div>
      </div>

      <div class="chat-container" id="chatContainer">
        <div class="empty-state">
          <div class="empty-state-icon">ğŸ’­</div>
          <div>è¿æ¥åˆ°æœåŠ¡å™¨åå¼€å§‹èŠå¤©</div>
        </div>
      </div>

      <div class="input-container">
        <div class="input-group">
          <input
            type="text"
            id="messageInput"
            placeholder="è¾“å…¥æ¶ˆæ¯..."
            disabled
            onkeypress="handleKeyPress(event)"
          />
          <button
            class="btn btn-primary"
            id="sendBtn"
            onclick="sendMessage()"
            disabled
          >
            å‘é€
          </button>
        </div>
      </div>
    </div>

    <!-- å¼•å…¥æ‰“åŒ…åçš„ UMD æ–‡ä»¶ -->
    <script src="../../dist/core/index.umd.js"></script>

    <script>
      // è·å– DOM å…ƒç´ 
      const statusEl = document.getElementById('status')
      const connectBtn = document.getElementById('connectBtn')
      const disconnectBtn = document.getElementById('disconnectBtn')
      const messageInput = document.getElementById('messageInput')
      const sendBtn = document.getElementById('sendBtn')
      const chatContainer = document.getElementById('chatContainer')
      const wsUrlInput = document.getElementById('wsUrl')
      const usernameInput = document.getElementById('username')

      // ä½¿ç”¨ UMD å…¨å±€å˜é‡
      const { WebSocketClient } = WebSocketCore

      let client = null
      let username = 'User'
      let messages = []
      let lastSentMessage = null // è®°å½•æœ€åå‘é€çš„æ¶ˆæ¯ï¼Œç”¨äºå»é‡

      // è¿æ¥
      function connect() {
        const url = wsUrlInput.value.trim()
        username = usernameInput.value.trim() || 'User'

        if (!url) {
          alert('è¯·è¾“å…¥ WebSocket URL')
          return
        }

        // å¦‚æœå·²ç»è¿æ¥ï¼Œå…ˆæ–­å¼€
        if (client) {
          disconnect()
        }

        // æ¸…ç©ºæ¶ˆæ¯åˆ—è¡¨
        messages = []
        renderMessages()

        try {
          // åˆ›å»ºå®¢æˆ·ç«¯
          // echo.websocket.org æ˜¯ä¸€ä¸ªç®€å•çš„ echo æœåŠ¡å™¨ï¼Œä¼šå›æ˜¾æ‰€æœ‰å‘é€çš„æ¶ˆæ¯
          // å®ƒä¸æ”¯æŒ ping/pong åè®®ï¼Œæ‰€ä»¥éœ€è¦ç¦ç”¨å¿ƒè·³å’Œ pong è¶…æ—¶æ£€æŸ¥
          client = new WebSocketClient({
            url: url,
            heartbeatInterval: false, // ç¦ç”¨å¿ƒè·³ï¼ˆecho æœåŠ¡å™¨ä¸æ”¯æŒï¼‰
            pongTimeout: false, // ç¦ç”¨ pong è¶…æ—¶æ£€æŸ¥
            reconnectDelay: 1000,
            maxReconnectDelay: 30000,
            strictJsonMode: false, // å…è®¸é JSON æ¶ˆæ¯
            messageParser: data => {
              // å¦‚æœæ˜¯å­—ç¬¦ä¸²
              if (typeof data === 'string') {
                // å°è¯•è§£æ JSON
                try {
                  const parsed = JSON.parse(data)

                  // è¿‡æ»¤æ‰è®¢é˜…/å–æ¶ˆè®¢é˜…çš„æ§åˆ¶æ¶ˆæ¯
                  // è¿™äº›æ˜¯åº“å†…éƒ¨å‘é€çš„æ¶ˆæ¯ï¼Œä¸åº”è¯¥æ˜¾ç¤ºç»™ç”¨æˆ·
                  // é€šè¿‡è¿”å›ä¸€ä¸ªä»¥ __ å¼€å¤´çš„ç‰¹æ®Š channelï¼Œåœ¨ handleMessage ä¸­ä¼šè¢«è¿‡æ»¤
                  if (
                    parsed &&
                    typeof parsed === 'object' &&
                    !Array.isArray(parsed) &&
                    (parsed.action === 'subscribe' ||
                      parsed.action === 'unsubscribe') &&
                    parsed.channel
                  ) {
                    // è¿”å›ä¸€ä¸ªç‰¹æ®Šçš„ channelï¼ˆä»¥ __ å¼€å¤´ï¼‰ï¼Œä¼šè¢« handleMessage è¿‡æ»¤
                    return {
                      channel: '__ignore__',
                      data: parsed
                    }
                  }

                  // æ£€æŸ¥æ˜¯å¦æ˜¯æ ‡å‡†æ¶ˆæ¯æ ¼å¼ { channel, data }
                  if ('channel' in parsed) {
                    return parsed
                  }

                  // å¦‚æœæ˜¯ JSON ä½†ä¸æ˜¯æ ‡å‡†æ ¼å¼ï¼ŒåŒ…è£…å®ƒ
                  return {
                    channel: 'message',
                    data: parsed
                  }
                } catch {
                  // ä¸æ˜¯ JSONï¼Œä½œä¸ºçº¯æ–‡æœ¬å¤„ç†
                  return {
                    channel: 'message',
                    data: data
                  }
                }
              }

              // å¤„ç†äºŒè¿›åˆ¶æ•°æ®ï¼ˆArrayBuffer æˆ– Blobï¼‰
              return {
                channel: 'binary',
                data: data
              }
            }
          })

          // ç›‘å¬è¿æ¥çŠ¶æ€
          client.onConnectionStateChange(connected => {
            updateConnectionStatus(connected)
          })

          // è®¢é˜…æ¶ˆæ¯ï¼ˆecho æœåŠ¡å™¨ä¼šå›æ˜¾æ‰€æœ‰æ¶ˆæ¯ï¼‰
          client.subscribe('message', data => {
            // echo.websocket.org è¿”å›çº¯æ–‡æœ¬å­—ç¬¦ä¸²
            const content =
              typeof data === 'string' ? data : JSON.stringify(data)

            // å¦‚æœè¿™æ˜¯åˆšæ‰å‘é€çš„æ¶ˆæ¯çš„å›æ˜¾ï¼Œä¸é‡å¤æ˜¾ç¤º
            // echo æœåŠ¡å™¨ä¼šåŸæ ·å›æ˜¾ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡å†…å®¹åŒ¹é…æ¥åˆ¤æ–­
            if (lastSentMessage && lastSentMessage === content) {
              lastSentMessage = null // æ¸…é™¤æ ‡è®°
              return // ä¸æ˜¾ç¤ºå›æ˜¾ï¼Œå› ä¸ºå·²ç»åœ¨å‘é€æ—¶æ˜¾ç¤ºäº†
            }

            // æ˜¾ç¤ºæœåŠ¡å™¨å›æ˜¾çš„æ¶ˆæ¯
            addMessage({
              user: 'Echo',
              content: content,
              time: new Date(),
              isOwn: false
            })
          })

          // è¿æ¥
          client.connect()

          // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
          addSystemMessage('æ­£åœ¨è¿æ¥...')
        } catch (error) {
          console.error('è¿æ¥å¤±è´¥:', error)
          alert('è¿æ¥å¤±è´¥: ' + error.message)
        }
      }

      // æ–­å¼€è¿æ¥
      function disconnect() {
        if (client) {
          client.disconnect()
          client = null
          messages = [] // æ¸…ç©ºæ¶ˆæ¯åˆ—è¡¨
          lastSentMessage = null // æ¸…é™¤å‘é€æ¶ˆæ¯æ ‡è®°
          renderMessages() // é‡æ–°æ¸²æŸ“
          addSystemMessage('å·²æ–­å¼€è¿æ¥')
        }
      }

      // å‘é€æ¶ˆæ¯
      function sendMessage() {
        const content = messageInput.value.trim()

        if (!content) return
        if (!client || !client.isConnected()) {
          alert('è¯·å…ˆè¿æ¥åˆ°æœåŠ¡å™¨')
          return
        }

        try {
          // è®°å½•å‘é€çš„æ¶ˆæ¯ï¼Œç”¨äºå»é‡
          lastSentMessage = content

          // å‘é€æ¶ˆæ¯åˆ°æœåŠ¡å™¨
          // echo.websocket.org ä¼šåŸæ ·å›æ˜¾å‘é€çš„æ¶ˆæ¯
          client.send(content)

          // æ·»åŠ è‡ªå·±çš„æ¶ˆæ¯åˆ°åˆ—è¡¨ï¼ˆç«‹å³æ˜¾ç¤ºï¼Œä¸ç­‰æœåŠ¡å™¨å›æ˜¾ï¼‰
          addMessage({
            user: username,
            content: content,
            time: new Date(),
            isOwn: true
          })

          // æ¸…ç©ºè¾“å…¥æ¡†
          messageInput.value = ''
        } catch (error) {
          console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error)
          alert('å‘é€æ¶ˆæ¯å¤±è´¥: ' + error.message)
          lastSentMessage = null // æ¸…é™¤æ ‡è®°
        }
      }

      // å¤„ç†å›è½¦é”®
      function handleKeyPress(event) {
        if (event.key === 'Enter') {
          sendMessage()
        }
      }

      // æ›´æ–°è¿æ¥çŠ¶æ€
      function updateConnectionStatus(connected) {
        if (connected) {
          statusEl.textContent = 'å·²è¿æ¥'
          statusEl.className = 'status connected'
          connectBtn.disabled = true
          disconnectBtn.disabled = false
          messageInput.disabled = false
          sendBtn.disabled = false
          addSystemMessage('è¿æ¥æˆåŠŸï¼')
        } else {
          statusEl.textContent = 'æœªè¿æ¥'
          statusEl.className = 'status disconnected'
          connectBtn.disabled = false
          disconnectBtn.disabled = true
          messageInput.disabled = true
          sendBtn.disabled = true
        }
      }

      // æ·»åŠ æ¶ˆæ¯
      function addMessage(message) {
        messages.push(message)
        renderMessages()
      }

      // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
      function addSystemMessage(content) {
        messages.push({
          type: 'system',
          content: content,
          time: new Date()
        })
        renderMessages()
      }

      // æ¸²æŸ“æ¶ˆæ¯åˆ—è¡¨
      function renderMessages() {
        if (messages.length === 0) {
          chatContainer.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">ğŸ’­</div>
              <div>è¿˜æ²¡æœ‰æ¶ˆæ¯</div>
            </div>
          `
          return
        }

        chatContainer.innerHTML = messages
          .map(msg => {
            if (msg.type === 'system') {
              return `
              <div class="message system">
                <div class="message-content">${escapeHtml(msg.content)}</div>
              </div>
            `
            }

            const time = formatTime(msg.time)
            const ownClass = msg.isOwn ? 'own' : ''

            return `
            <div class="message ${ownClass}">
              <div class="message-header">
                <span class="message-user">${escapeHtml(msg.user)}</span>
                <span class="message-time">${time}</span>
              </div>
              <div class="message-content">${escapeHtml(msg.content)}</div>
            </div>
          `
          })
          .join('')

        // æ»šåŠ¨åˆ°åº•éƒ¨
        chatContainer.scrollTop = chatContainer.scrollHeight
      }

      // æ ¼å¼åŒ–æ—¶é—´
      function formatTime(date) {
        const hours = String(date.getHours()).padStart(2, '0')
        const minutes = String(date.getMinutes()).padStart(2, '0')
        return `${hours}:${minutes}`
      }

      // è½¬ä¹‰ HTML
      function escapeHtml(text) {
        const div = document.createElement('div')
        div.textContent = text
        return div.innerHTML
      }

      // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
      window.addEventListener('load', () => {
        console.log('WebSocket Client Demo loaded')
        console.log('Available:', typeof WebSocketCore !== 'undefined')
      })

      // é¡µé¢å…³é—­å‰æ–­å¼€è¿æ¥
      window.addEventListener('beforeunload', () => {
        if (client) {
          client.disconnect()
        }
      })
    </script>
  </body>
</html>
